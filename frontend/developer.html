<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Developer Console</title>

<link rel="stylesheet" href="/style.css">

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2196f3">
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(()=> console.log('SW registered (dev)')).catch(()=>{});
}
</script>
</head>
<body>
<header class="topbar">
  <div class="brand">Developer Console</div>
  <div style="flex:1"></div>
  <a class="btn" href="index.html">Back to Store</a>
</header>

<main class="container">
  <section class="upload-card">
    <h2>Upload New App</h2>
    <form id="uploadForm" enctype="multipart/form-data">
      <label>App name</label><br>
      <input name="appName" required /><br><br>

      <label>Description</label><br>
      <textarea name="description" rows="4" required></textarea><br><br>

      <label>Icon (PNG/JPG)</label><br>
      <input type="file" name="icon" accept="image/png,image/jpeg" required /><br><br>

      <label>APK file</label><br>
      <input type="file" name="apk" accept=".apk" required /><br><br>

      <div style="display:flex;gap:10px">
        <button class="btn" type="submit">Upload (pending)</button>
        <button type="button" id="refreshMyApps" class="btn">Refresh My Apps</button>
      </div>

      <p id="uploadMsg" class="msg"></p>
    </form>
  </section>

  <section style="margin-top:22px">
    <h3>My uploaded apps (all statuses)</h3>
    <div id="myApps"></div>
  </section>
</main>

<script>
  // protect page: allow only developer or admin
  (function(){
    const raw = localStorage.getItem("apk_user");
    if (!raw) { window.location.href = "login.html"; return; }
    const user = JSON.parse(raw);
    if (!(user.role === "developer" || user.role === "admin")) {
      alert("Developer access required");
      window.location.href = "index.html";
      return;
    }
  })();

  document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = JSON.parse(localStorage.getItem("apk_user") || "null");
    if (!user) { alert("Please log in"); window.location.href = "login.html"; return; }

    const fd = new FormData(e.target);
    fd.append("uploader", user.username);

    const res = await fetch("/upload-app", { method: "POST", body: fd });
    const j = await res.json();
    const msg = document.getElementById("uploadMsg");
    if (j.success) {
      msg.style.color = "#bfffcf";
      msg.textContent = "Uploaded â€” pending admin approval.";
      e.target.reset();
      loadMyApps();
    } else {
      msg.style.color = "#ffdede";
      msg.textContent = "Upload failed: " + (j.message || "unknown");
    }
  });

  async function loadMyApps() {
    // we will reuse GET /pending-apps and filter by uploader
    const res = await fetch("/pending-apps");
    const list = await res.json();
    const user = JSON.parse(localStorage.getItem("apk_user") || "null");
    const container = document.getElementById("myApps");
    container.innerHTML = "";
    const filtered = list.filter(a => a.uploader === user.username);
    if (filtered.length === 0) container.innerHTML = "<p class='msg'>No uploaded apps (pending or approved will show after admin approval)</p>";
    filtered.forEach(a => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <img src="${a.icon}" alt="${a.appName}">
        <h3>${escapeHtml(a.appName)}</h3>
        <p>${escapeHtml(a.description)}</p>
        <p>Status: <strong>${a.approved ? "approved" : "pending"}</strong></p>
      `;
      container.appendChild(div);
    });
  }
  document.getElementById("refreshMyApps").addEventListener("click", loadMyApps);
  window.addEventListener("DOMContentLoaded", loadMyApps);

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>
